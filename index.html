<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive File Manager</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1f2937; /* Solid dark gray background */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal {
            @apply bg-white p-6 rounded-lg shadow-xl max-w-lg w-full transform transition-transform duration-300 scale-95;
        }
        .modal-open {
            display: flex;
        }
        .modal-open .modal {
            transform: scale(1);
        }
        .document-card {
            @apply bg-white border border-gray-200 rounded-lg p-5 shadow-sm space-y-2 hover:shadow-md transition-shadow duration-200 flex flex-col justify-between;
            min-height: 16rem; /* Ensures uniform height */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Main Application Container -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">

        <!-- Header and Login/Logout Button -->
        <header class="flex flex-col md:flex-row justify-between items-center pb-4 border-b border-gray-200">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2 md:mb-0">Executive File Manager</h1>
            <div class="flex items-center space-x-2">
                <span id="userIdDisplay" class="text-sm text-gray-500 font-medium hidden"></span>
                <button id="authButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-5 rounded-full transition-colors duration-200">
                    Login
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="space-y-8">

            <!-- Search and Filter Section -->
            <section class="mt-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="searchInput" placeholder="Search documents..." class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
            </section>

            <!-- Public Document List -->
            <section>
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Public Documents <span class="text-base text-gray-500 font-normal">(Sorted by date, newest first)</span></h2>
                <div id="documentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Documents will be dynamically inserted here -->
                </div>
            </section>

            <!-- Admin Section (Hidden by Default) -->
            <section id="adminSection" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-900 mb-4">Admin Panel</h2>
                
                <!-- Manage Categories Section -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner space-y-4 mb-6">
                    <h3 class="text-xl font-medium text-gray-700">Manage Categories</h3>
                    
                    <!-- Add New Category -->
                    <div class="flex flex-col md:flex-row md:items-end gap-4">
                        <div class="flex-grow flex flex-col">
                            <label for="newCategoryInput" class="text-sm font-medium text-gray-600">Add New Category</label>
                            <input type="text" id="newCategoryInput" placeholder="Enter category name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <button type="button" id="addCategoryButton" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-5 rounded-md transition-colors duration-200">
                            Add Category
                        </button>
                    </div>

                    <!-- Existing Categories List -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">Your Custom Categories</h4>
                        <div id="categoriesList" class="space-y-2">
                            <!-- Categories will be dynamically inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Document Form -->
                <form id="documentForm" class="bg-gray-50 p-6 rounded-xl shadow-inner space-y-4">
                    <h3 id="formTitle" class="text-xl font-medium text-gray-700">Add New Document</h3>
                    <input type="hidden" id="documentId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="DocumentNumber" class="text-sm font-medium text-gray-600">Document Number</label>
                            <input type="text" id="DocumentNumber" required placeholder="e.g., EO-2023-01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="category" class="text-sm font-medium text-gray-600">Category</label>
                            <select id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <!-- Categories will be dynamically populated here -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex flex-col">
                        <label for="title" class="text-sm font-medium text-gray-600">Title</label>
                        <input type="text" id="title" required placeholder="Enter document title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="date" class="text-sm font-medium text-gray-600">Date</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="googleDriveLink" class="text-sm font-medium text-gray-600">Google Drive Link</label>
                            <input type="url" id="googleDriveLink" required placeholder="https://drive.google.com/..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <label for="status" class="text-sm font-medium text-gray-600">Status</label>
                        <select id="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="Completed">Completed</option>
                            <option value="Pending">Pending</option>
                            <option value="Custom Remarks">Custom Remarks</option>
                        </select>
                    </div>

                    <div id="customRemarksContainer" class="flex flex-col hidden">
                        <label for="customRemarks" class="text-sm font-medium text-gray-600">Custom Remarks</label>
                        <input type="text" id="customRemarks" placeholder="Enter custom remarks" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-md transition-colors duration-200">
                        Add Document
                    </button>
                </form>
            </section>
        </main>
    </div>

    <!-- Modals -->

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Admin Login</h3>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="email" required placeholder="Email" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <input type="password" id="password" required placeholder="Password" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div class="text-center text-sm text-red-500 mt-2 hidden" id="loginErrorMessage"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-md transition-colors duration-200">
                    Login
                </button>
                <a href="#" id="forgotPasswordLink" class="text-xs text-indigo-600 hover:text-indigo-800 transition-colors duration-200 mt-2 block text-center">Forgot Password?</a>
            </form>
            <button id="closeLoginModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Forgot Password</h3>
            <p class="text-sm text-gray-600">Enter your email to receive a password reset link.</p>
            <form id="forgotPasswordForm" class="space-y-4">
                <input type="email" id="resetEmail" required placeholder="Email" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div id="resetMessage" class="text-sm font-medium text-center hidden"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-md transition-colors duration-200">
                    Send Reset Link
                </button>
            </form>
            <button id="closeForgotPasswordModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal (Re-used for Documents and Categories) -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Confirm Deletion</h3>
            <p id="deleteMessage">Are you sure you want to delete this document? This action cannot be undone.</p>
            <div id="deleteError" class="text-sm text-red-500 font-medium text-center hidden"></div>
            <div class="flex justify-end space-x-2">
                <button id="cancelDeleteButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition-colors duration-200">Cancel</button>
                <button id="confirmDeleteButton" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">Delete</button>
            </div>
        </div>
    </div>

    <!-- Rename Category Modal -->
    <div id="renameCategoryModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Rename Category</h3>
            <form id="renameCategoryForm" class="space-y-4">
                <input type="hidden" id="renameCategoryId">
                <input type="text" id="renameCategoryInput" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelRenameButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                        Rename
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        
        // Mandatory global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is not defined. Please check your environment.");
            document.getElementById('documentsList').innerHTML = `<p class="text-red-500">Firebase is not configured. Please contact the administrator.</p>`;
            document.getElementById('authButton').disabled = true;
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Setting Firebase log level to debug for better error tracing
        setLogLevel('debug');
        
        // --- DOM Elements ---
        const authButton = document.getElementById('authButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const documentsList = document.getElementById('documentsList');
        const adminSection = document.getElementById('adminSection');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const documentForm = document.getElementById('documentForm');
        const documentIdInput = document.getElementById('documentId');
        const formTitle = document.getElementById('formTitle');
        const submitButton = document.getElementById('submitButton');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const deleteError = document.getElementById('deleteError');
        const statusSelect = document.getElementById('status');
        const customRemarksContainer = document.getElementById('customRemarksContainer');
        const customRemarksInput = document.getElementById('customRemarks');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const closeForgotPasswordModal = document.getElementById('closeForgotPasswordModal');
        const resetMessage = document.getElementById('resetMessage');
        const categorySelect = document.getElementById('category');
        const newCategoryInput = document.getElementById('newCategoryInput');
        const addCategoryButton = document.getElementById('addCategoryButton');
        const categoriesList = document.getElementById('categoriesList');
        const renameCategoryModal = document.getElementById('renameCategoryModal');
        const renameCategoryForm = document.getElementById('renameCategoryForm');
        const renameCategoryIdInput = document.getElementById('renameCategoryId');
        const renameCategoryInput = document.getElementById('renameCategoryInput');
        const cancelRenameButton = document.getElementById('cancelRenameButton');
        const searchInput = document.getElementById('searchInput');
        const loginErrorMessage = document.getElementById('loginErrorMessage');

        let currentUserId = null;
        let allDocuments = [];
        let allCategories = [];
        let unsubscribeFromDocuments = null;
        let unsubscribeFromCategories = null;

        // --- Event Listeners and Functions ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = `User ID: ${user.uid}`;
                userIdDisplay.classList.remove('hidden');
                authButton.textContent = 'Logout';
                adminSection.classList.remove('hidden');
                console.log("User authenticated:", user.uid);
                
                // Set up real-time listeners for authenticated users
                setupFirestoreListeners();
            } else {
                currentUserId = null;
                userIdDisplay.textContent = '';
                userIdDisplay.classList.add('hidden');
                authButton.textContent = 'Login';
                adminSection.classList.add('hidden');
                
                // Detach real-time listeners if they exist
                if (unsubscribeFromDocuments) unsubscribeFromDocuments();
                if (unsubscribeFromCategories) unsubscribeFromCategories();
            }
        });

        // Sign in anonymously on page load
        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token).catch((e) => console.error("Firebase Auth Error:", e));
        } else {
            await signInAnonymously(auth).catch((e) => console.error("Firebase Auth Error:", e));
        }

        function setupFirestoreListeners() {
            // Document listener
            const documentsCollection = collection(db, `artifacts/${appId}/public/data/documents`);
            unsubscribeFromDocuments = onSnapshot(documentsCollection, (snapshot) => {
                const fetchedDocs = [];
                snapshot.forEach(doc => {
                    fetchedDocs.push({ id: doc.id, ...doc.data() });
                });
                // Sort documents by date, newest first
                fetchedDocs.sort((a, b) => new Date(b.date) - new Date(a.date));
                allDocuments = fetchedDocs;
                filterAndRenderDocuments();
            }, (error) => {
                console.error("Error fetching documents:", error);
                documentsList.innerHTML = `<p class="text-center text-red-500 col-span-full">Failed to load documents. Please try again later.</p>`;
            });

            // Category listener
            const categoriesCollection = collection(db, `artifacts/${appId}/public/data/categories`);
            unsubscribeFromCategories = onSnapshot(categoriesCollection, (snapshot) => {
                const fetchedCats = [];
                snapshot.forEach(doc => {
                    fetchedCats.push({ id: doc.id, name: doc.data().name });
                });
                allCategories = fetchedCats;
                renderCategories(allCategories);
            }, (error) => {
                console.error("Error fetching categories:", error);
            });
        }
        
        // Handle login/logout based on auth state
        authButton.addEventListener('click', () => {
            if (currentUserId) {
                signOut(auth).then(() => {
                    console.log("User signed out.");
                }).catch((error) => {
                    console.error("Error signing out:", error);
                });
            } else {
                loginModal.classList.add('modal-open');
                loginErrorMessage.classList.add('hidden');
            }
        });
        
        // Handle form submission for login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    console.log("User logged in:", userCredential.user.uid);
                    loginModal.classList.remove('modal-open');
                    loginForm.reset();
                })
                .catch((error) => {
                    console.error("Login failed:", error.message);
                    loginErrorMessage.textContent = "Login failed. Please check your credentials.";
                    loginErrorMessage.classList.remove('hidden');
                });
        });

        // Close login modal
        closeLoginModal.addEventListener('click', () => {
            loginModal.classList.remove('modal-open');
            loginForm.reset();
        });
        
        // Handle forgot password link click
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.remove('modal-open');
            forgotPasswordModal.classList.add('modal-open');
            resetMessage.textContent = '';
            resetMessage.classList.add('hidden');
        });
        
        // Close forgot password modal
        closeForgotPasswordModal.addEventListener('click', () => {
            forgotPasswordModal.classList.remove('modal-open');
        });

        // Handle forgot password form submission
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            resetMessage.classList.remove('hidden');
            resetMessage.classList.remove('text-red-500', 'text-green-500');

            try {
                await sendPasswordResetEmail(auth, email);
                resetMessage.textContent = 'Password reset email sent! Check your inbox.';
                resetMessage.classList.add('text-green-500');
            } catch (error) {
                console.error("Password reset failed:", error.message);
                resetMessage.textContent = 'Failed to send reset email. Please check the email address.';
                resetMessage.classList.add('text-red-500');
            }
        });

        // Handle adding a new category
        addCategoryButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                console.error("Permission denied. You must be an admin to add a category.");
                return;
            }
            
            const newCategory = newCategoryInput.value.trim();
            if (newCategory) {
                try {
                    const categoriesCollection = collection(db, `artifacts/${appId}/public/data/categories`);
                    await addDoc(categoriesCollection, { name: newCategory });
                    newCategoryInput.value = '';
                    console.log("Category added successfully!");
                } catch (e) {
                    console.error("Error adding category: ", e);
                }
            }
        });

        // Toggle custom remarks input based on status selection
        statusSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Custom Remarks') {
                customRemarksContainer.classList.remove('hidden');
                customRemarksInput.required = true;
            } else {
                customRemarksContainer.classList.add('hidden');
                customRemarksInput.required = false;
            }
        });

        // Handle form submission for adding/updating documents
        documentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                console.error("Permission denied. You must be an admin to add/edit a document.");
                return;
            }

            const docId = documentIdInput.value;
            const docData = {
                DocumentNumber: document.getElementById('DocumentNumber').value,
                category: document.getElementById('category').value,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                googleDriveLink: document.getElementById('googleDriveLink').value,
                status: statusSelect.value,
                customRemarks: customRemarksInput.value || ""
            };
            
            try {
                if (docId) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/documents`, docId);
                    await updateDoc(docRef, docData);
                    console.log("Document updated successfully!");
                } else {
                    const docRef = collection(db, `artifacts/${appId}/public/data/documents`);
                    await addDoc(docRef, docData);
                    console.log("Document added successfully!");
                }
                
                documentForm.reset();
                documentIdInput.value = '';
                formTitle.textContent = 'Add New Document';
                submitButton.textContent = 'Add Document';
                customRemarksContainer.classList.add('hidden');
                customRemarksInput.required = false;

            } catch (e) {
                console.error("Error adding/updating document: ", e);
            }
        });
        
        // Search and filter function
        function filterAndRenderDocuments() {
            const searchTerm = searchInput.value.toLowerCase();
            let filteredDocs = [];

            if (!searchTerm) {
                filteredDocs = allDocuments;
            } else {
                filteredDocs = allDocuments.filter(doc => {
                    return Object.values(doc).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(searchTerm);
                        }
                        return false;
                    });
                });
            }
            renderDocuments(filteredDocs);
        }

        // Add event listener for search input
        searchInput.addEventListener('input', filterAndRenderDocuments);

        // Function to render documents to the UI
        function renderDocuments(documents) {
            documentsList.innerHTML = '';
            
            if (documents.length === 0) {
                documentsList.innerHTML = `<p class="text-center text-gray-500 col-span-full">No documents found.</p>`;
                return;
            }

            documents.forEach(doc => {
                const docCard = document.createElement('div');
                docCard.className = `document-card relative`;
                docCard.innerHTML = `
                    <div class="flex-grow space-y-2">
                        <h4 class="text-lg font-semibold text-gray-900">${doc.title}</h4>
                        <p class="text-sm text-gray-600"><strong>Document:</strong> ${doc.DocumentNumber}</p>
                        <p class="text-sm text-gray-600"><strong>Category:</strong> ${doc.category}</p>
                        <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(doc.date).toLocaleDateString()}</p>
                        <p class="text-sm font-medium ${doc.status === 'Completed' ? 'text-green-600' : 'text-yellow-600'}"><strong>Status:</strong> ${doc.status}</p>
                        ${doc.status === 'Custom Remarks' && doc.customRemarks ? `<p class="text-xs text-gray-500 italic mt-1">"${doc.customRemarks}"</p>` : ''}
                    </div>
                    <div class="pt-2 border-t border-gray-100 mt-2">
                        <a href="${doc.googleDriveLink}" target="_blank" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            View Document
                        </a>
                    </div>
                `;

                if (currentUserId) {
                    const adminActions = document.createElement('div');
                    adminActions.className = "flex space-x-2 absolute top-4 right-4";
                    adminActions.innerHTML = `
                        <button class="edit-doc-btn text-blue-500 hover:text-blue-700 transition-colors duration-200" data-id="${doc.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button class="delete-doc-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${doc.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    docCard.appendChild(adminActions);
                }
                
                documentsList.appendChild(docCard);
            });
            
            // Add listeners for edit/delete buttons after rendering
            if (currentUserId) {
                document.querySelectorAll('.edit-doc-btn').forEach(button => {
                    button.addEventListener('click', () => editDocument(button.dataset.id));
                });
                document.querySelectorAll('.delete-doc-btn').forEach(button => {
                    button.addEventListener('click', () => openDeleteModal(button.dataset.id, 'document'));
                });
            }
        }
        
        // Open delete confirmation modal
        function openDeleteModal(itemId, itemType) {
            deleteModal.classList.add('modal-open');
            confirmDeleteButton.dataset.id = itemId;
            confirmDeleteButton.dataset.type = itemType;
            deleteError.classList.add('hidden');
            document.getElementById('deleteMessage').textContent = `Are you sure you want to delete this ${itemType}? This action cannot be undone.`;
        }

        // Close delete modal and handle cancel
        cancelDeleteButton.addEventListener('click', () => {
            deleteModal.classList.remove('modal-open');
        });

        // Handle delete confirmation
        confirmDeleteButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                deleteError.textContent = "Permission denied. You must be an admin to delete.";
                deleteError.classList.remove('hidden');
                console.error("Permission denied. No user logged in.");
                return;
            }
            
            const itemId = confirmDeleteButton.dataset.id;
            const itemType = confirmDeleteButton.dataset.type;
            
            try {
                if (itemType === 'document') {
                    const docRef = doc(db, `artifacts/${appId}/public/data/documents`, itemId);
                    await deleteDoc(docRef);
                    console.log("Document deleted successfully!");
                } else if (itemType === 'category') {
                    const docRef = doc(db, `artifacts/${appId}/public/data/categories`, itemId);
                    await deleteDoc(docRef);
                    console.log("Category deleted successfully!");
                }
                deleteModal.classList.remove('modal-open');
            } catch (e) {
                console.error(`Error deleting ${itemType}: `, e);
                deleteError.textContent = `Error: ${e.message}. Deletion failed.`;
                deleteError.classList.remove('hidden');
            }
        });

        // Function to load document data into the form for editing
        async function editDocument(docId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/documents`, docId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    documentIdInput.value = docId;
                    formTitle.textContent = 'Edit Document';
                    submitButton.textContent = 'Update Document';
                    
                    document.getElementById('DocumentNumber').value = data.DocumentNumber;
                    document.getElementById('category').value = data.category;
                    document.getElementById('title').value = data.title;
                    document.getElementById('date').value = data.date;
                    document.getElementById('googleDriveLink').value = data.googleDriveLink;
                    statusSelect.value = data.status;

                    if (data.status === 'Custom Remarks') {
                        customRemarksContainer.classList.remove('hidden');
                        customRemarksInput.value = data.customRemarks;
                    } else {
                        customRemarksContainer.classList.add('hidden');
                        customRemarksInput.value = '';
                    }
                    
                    adminSection.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (e) {
                console.error("Error fetching document for edit: ", e);
            }
        }

        function renderCategories(categories) {
            categorySelect.innerHTML = categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            categoriesList.innerHTML = '';
            if (categories.length === 0) {
                categoriesList.innerHTML = `<p class="text-center text-gray-500">No categories found.</p>`;
                return;
            }
            categories.forEach(cat => {
                const categoryItem = document.createElement('div');
                categoryItem.className = `flex justify-between items-center bg-white border border-gray-200 rounded-lg p-3 shadow-sm`;
                categoryItem.innerHTML = `
                    <span class="font-medium text-gray-700">${cat.name}</span>
                    <div class="flex space-x-2">
                        <button class="rename-cat-btn text-blue-500 hover:text-blue-700 transition-colors duration-200" data-id="${cat.id}" data-name="${cat.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button class="delete-cat-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${cat.id}" data-name="${cat.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                categoriesList.appendChild(categoryItem);
            });
            document.querySelectorAll('.rename-cat-btn').forEach(button => {
                button.addEventListener('click', () => openRenameCategoryModal(button.dataset.id, button.dataset.name));
            });
            document.querySelectorAll('.delete-cat-btn').forEach(button => {
                button.addEventListener('click', () => openDeleteModal(button.dataset.id, 'category'));
            });
        }

        // Open rename category modal
        function openRenameCategoryModal(id, name) {
            renameCategoryModal.classList.add('modal-open');
            renameCategoryIdInput.value = id;
            renameCategoryInput.value = name;
        }

        // Close rename category modal
        cancelRenameButton.addEventListener('click', () => {
            renameCategoryModal.classList.remove('modal-open');
        });

        // Handle rename category form submission
        renameCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                console.error("Permission denied. You must be an admin to rename a category.");
                return;
            }
            const catId = renameCategoryIdInput.value;
            const newName = renameCategoryInput.value.trim();
            if (newName) {
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/categories`, catId);
                    await updateDoc(docRef, { name: newName });
                    renameCategoryModal.classList.remove('modal-open');
                    console.log("Category renamed successfully!");
                } catch (e) {
                    console.error("Error renaming category: ", e);
                }
            }
        });

    </script>
</body>
</html>
