<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive File Manager</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FFFFFF; /* Solid dark gray background */
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal {
            @apply bg-white p-6 rounded-lg shadow-xl max-w-lg w-full transform transition-transform duration-300 scale-95;
        }
        .modal-open {
            display: flex;
        }
        .modal-open .modal {
            transform: scale(1);
        }

        /* Custom scrollbar for card content */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">

        <header class="flex flex-col md:flex-row justify-between items-center pb-4 border-b border-gray-200">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2 md:mb-0">Executive File Manager</h1>
            <div class="flex items-center space-x-2">
                <span id="userIdDisplay" class="text-sm text-gray-500 font-medium hidden"></span>
                <button id="authButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-5 rounded-full transition-colors duration-200">
                    Login
                </button>
            </div>
        </header>

        <main class="space-y-8">

            <section>
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2 md:mb-0">Public Documents</h2>
                    <div class="flex items-center space-x-2">
                        <label for="categoryFilter" class="text-sm font-normal text-gray-500">Filter by Category:</label>
                        <select id="categoryFilter" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                            <option value="">Select a Category</option>
                        </select>
                    </div>
                </div>
                <div id="documentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </section>

            <section id="adminSection" class="hidden">
                <h2 class="text-2xl font-semibold text-white-900 mb-4">Admin Panel</h2>
                
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner space-y-4 mb-6">
                    <h3 class="text-xl font-medium text-gray-700">Manage Categories</h3>
                    
                    <div class="flex flex-col md:flex-row md:items-end gap-4">
                        <div class="flex-grow flex flex-col">
                            <label for="newCategoryInput" class="text-sm font-medium text-gray-600">Add New Category</label>
                            <input type="text" id="newCategoryInput" placeholder="Enter category name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <button type="button" id="addCategoryButton" class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-5 rounded-md transition-colors duration-200">
                            Add Category
                        </button>
                    </div>

                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">Your Custom Categories</h4>
                        <div id="categoriesList" class="space-y-2">
                            </div>
                    </div>
                </div>

                <form id="documentForm" class="bg-gray-50 p-6 rounded-xl shadow-inner space-y-4">
                    <h3 id="formTitle" class="text-xl font-medium text-gray-700">Add New Document</h3>
                    <input type="hidden" id="documentId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="DocumentNumber" class="text-sm font-medium text-gray-600">Document Number</label>
                            <input type="text" id="DocumentNumber" required placeholder="e.g., EO-2023-01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="category" class="text-sm font-medium text-gray-600">Category</label>
                            <select id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                </select>
                        </div>
                    </div>
                    
                    <div class="flex flex-col">
                        <label for="title" class="text-sm font-medium text-gray-600">Title</label>
                        <input type="text" id="title" required placeholder="Enter document title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label for="date" class="text-sm font-medium text-gray-600">Date</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="googleDriveLink" class="text-sm font-medium text-gray-600">Google Drive Link</label>
                            <input type="url" id="googleDriveLink" required placeholder="https://drive.google.com/..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>

                    <div class="flex flex-col">
                        <label for="status" class="text-sm font-medium text-gray-600">Status</label>
                        <select id="status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="Completed">Completed</option>
                            <option value="Pending">Pending</option>
                            <option value="Custom Remarks">Custom Remarks</option>
                        </select>
                    </div>

                    <div id="customRemarksContainer" class="flex flex-col hidden">
                        <label for="customRemarks" class="text-sm font-medium text-gray-600">Custom Remarks</label>
                        <input type="text" id="customRemarks" placeholder="Enter custom remarks" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>

                    <button type="submit" id="submitButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-md transition-colors duration-200">
                        Add Document
                    </button>
                </form>
            </section>
        </main>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Admin Login</h3>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="email" required placeholder="Email" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <input type="password" id="password" required placeholder="Password" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-md transition-colors duration-200">
                    Login
                </button>
                <a href="#" id="forgotPasswordLink" class="text-xs text-indigo-600 hover:text-indigo-800 transition-colors duration-200 mt-2 block text-center">Forgot Password?</a>
            </form>
            <button id="closeLoginModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
        </div>
    </div>
    
    <div id="forgotPasswordModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Forgot Password</h3>
            <p class="text-sm text-gray-600">Enter your email to receive a password reset link.</p>
            <form id="forgotPasswordForm" class="space-y-4">
                <input type="email" id="resetEmail" required placeholder="Email" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div id="resetMessage" class="text-sm font-medium text-center hidden"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-md transition-colors duration-200">
                    Send Reset Link
                </button>
            </form>
            <button id="closeForgotPasswordModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200">&times;</button>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Confirm Deletion</h3>
            <p id="deleteMessage">Are you sure you want to delete this document? This action cannot be undone.</p>
            <div id="deleteError" class="text-sm text-red-500 font-medium text-center hidden"></div>
            <div class="flex justify-end space-x-2">
                <button id="cancelDeleteButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition-colors duration-200">Cancel</button>
                <button id="confirmDeleteButton" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">Delete</button>
            </div>
        </div>
    </div>

    <div id="renameCategoryModal" class="modal-overlay">
        <div class="modal space-y-4">
            <h3 class="text-xl font-bold text-gray-900">Rename Category</h3>
            <form id="renameCategoryForm" class="space-y-4">
                <input type="hidden" id="renameCategoryId">
                <input type="text" id="renameCategoryInput" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelRenameButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition-colors duration-200">
                        Rename
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        
        // Mandatory global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyBp65b43DD_05DI6iZ5CZJZnOoT_um4QRA",
          authDomain: "my-project-4325e.firebaseapp.com",
          projectId: "my-project-4325e",
          storageBucket: "my-project-4325e.firebasestorage.app",
          messagingSenderId: "990130305222",
          appId: "1:990130305222:web:0de830e1652ea5ed703fc7",
          measurementId: "G-W7CSTWS8JP"
        };
        
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is not defined. Please check your environment.");
            // Gracefully exit or show an error to the user
            document.getElementById('documentsList').innerHTML = `<p class="text-red-500">Firebase is not configured. Please contact the administrator.</p>`;
            document.getElementById('authButton').disabled = true;
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Setting Firebase log level to debug for better error tracing
        setLogLevel('debug');
        
        // --- DOM Elements ---
        const authButton = document.getElementById('authButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const documentsList = document.getElementById('documentsList');
        const adminSection = document.getElementById('adminSection');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const documentForm = document.getElementById('documentForm');
        const documentIdInput = document.getElementById('documentId');
        const formTitle = document.getElementById('formTitle');
        const submitButton = document.getElementById('submitButton');
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const deleteError = document.getElementById('deleteError');
        const statusSelect = document.getElementById('status');
        const customRemarksContainer = document.getElementById('customRemarksContainer');
        const customRemarksInput = document.getElementById('customRemarks');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const closeForgotPasswordModal = document.getElementById('closeForgotPasswordModal');
        const resetMessage = document.getElementById('resetMessage');
        const categorySelect = document.getElementById('category');
        const newCategoryInput = document.getElementById('newCategoryInput');
        const addCategoryButton = document.getElementById('addCategoryButton');
        const categoriesList = document.getElementById('categoriesList');
        const renameCategoryModal = document.getElementById('renameCategoryModal');
        const renameCategoryForm = document.getElementById('renameCategoryForm');
        const renameCategoryIdInput = document.getElementById('renameCategoryId');
        const renameCategoryInput = document.getElementById('renameCategoryInput');
        const cancelRenameButton = document.getElementById('cancelRenameButton');

        // Search DOM elements
        const categoryFilter = document.getElementById('categoryFilter');
        
        let currentUserId = null;
        // Variable to hold the unsubscribe function for the Firestore listener
        let unsubscribeFromFirestore = null;
        let unsubscribeFromCategories = null;

        // Global variable to store all documents
        let allDocuments = [];

        // --- Event Listeners and Functions ---
        
        // Handle login/logout based on auth state
        authButton.addEventListener('click', () => {
            if (currentUserId) {
                // User is logged in, log them out
                signOut(auth).then(() => {
                    console.log("User signed out.");
                }).catch((error) => {
                    console.error("Error signing out:", error);
                });
            } else {
                // No user, show login modal
                loginModal.classList.add('modal-open');
            }
        });
        
        // Handle form submission for login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    console.log("User logged in:", userCredential.user.uid);
                    loginModal.classList.remove('modal-open');
                    loginForm.reset();
                })
                .catch((error) => {
                    console.error("Login failed:", error.message);
                    // Use a simple text update instead of alert
                    const errorMessage = loginForm.querySelector('.error-message');
                    if (errorMessage) errorMessage.remove();
                    const errorDiv = document.createElement('div');
                    errorDiv.className = "error-message text-center text-sm text-red-500 mt-2";
                    errorDiv.textContent = "Login failed. Please check your credentials.";
                    loginForm.appendChild(errorDiv);
                });
        });

        // Close login modal
        closeLoginModal.addEventListener('click', () => {
            loginModal.classList.remove('modal-open');
        });
        
        // Handle forgot password link click
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.remove('modal-open');
            forgotPasswordModal.classList.add('modal-open');
            resetMessage.textContent = '';
            resetMessage.classList.add('hidden');
        });
        
        // Close forgot password modal
        closeForgotPasswordModal.addEventListener('click', () => {
            forgotPasswordModal.classList.remove('modal-open');
        });

        // Handle forgot password form submission
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;
            resetMessage.classList.remove('hidden');
            resetMessage.classList.remove('text-red-500', 'text-green-500');

            try {
                await sendPasswordResetEmail(auth, email);
                resetMessage.textContent = 'Password reset email sent! Check your inbox.';
                resetMessage.classList.add('text-green-500');
            } catch (error) {
                console.error("Password reset failed:", error.message);
                resetMessage.textContent = 'Failed to send reset email. Please check the email address.';
                resetMessage.classList.add('text-red-500');
            }
        });

        // Handle adding a new category
        addCategoryButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                console.error("Permission denied. You must be an admin to add a category.");
                return;
            }
            
            const newCategory = newCategoryInput.value.trim();
            if (newCategory) {
                try {
                    const categoriesCollection = collection(db, `artifacts/${appId}/public/data/categories`);
                    await addDoc(categoriesCollection, { name: newCategory });
                    newCategoryInput.value = '';
                    console.log("Category added successfully!");
                } catch (e) {
                    console.error("Error adding category: ", e);
                }
            }
        });

        // Toggle custom remarks input based on status selection
        statusSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Custom Remarks') {
                customRemarksContainer.classList.remove('hidden');
                customRemarksInput.required = true;
            } else {
                customRemarksContainer.classList.add('hidden');
                customRemarksInput.required = false;
            }
        });

        // Handle form submission for adding/updating documents
        documentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                console.error("Permission denied. You must be an admin to add/edit a document.");
                return;
            }

            const docId = documentIdInput.value;
            const docData = {
                DocumentNumber: document.getElementById('DocumentNumber').value,
                category: document.getElementById('category').value,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                googleDriveLink: document.getElementById('googleDriveLink').value,
                status: statusSelect.value,
                customRemarks: customRemarksInput.value || ""
            };
            
            try {
                if (docId) {
                    // Update existing document
                    const docRef = doc(db, `artifacts/${appId}/public/data/documents`, docId);
                    await updateDoc(docRef, docData);
                    console.log("Document updated successfully!");
                } else {
                    // Add new document
                    const docRef = collection(db, `artifacts/${appId}/public/data/documents`);
                    await addDoc(docRef, docData);
                    console.log("Document added successfully!");
                }
                
                // Reset the form
                documentForm.reset();
                documentIdInput.value = '';
                formTitle.textContent = 'Add New Document';
                submitButton.textContent = 'Add Document';
                customRemarksContainer.classList.add('hidden');
                customRemarksInput.required = false;

            } catch (e) {
                console.error("Error adding/updating document: ", e);
            }
        });
        
        // Function to render documents to the UI
        function renderDocuments(documents) {
            documentsList.innerHTML = '';
            
            if (documents.length === 0) {
                documentsList.innerHTML = `<p class="text-center text-gray-500 col-span-full">No documents found in this category.</p>`;
                return;
            }

            documents.forEach(doc => {
                const docCard = document.createElement('div');
                docCard.className = `relative flex flex-col justify-between min-h-[12rem] bg-white border border-gray-200 rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow duration-200`;
                docCard.innerHTML = `
                    <div class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                        <h4 class="text-base font-semibold text-gray-900">${doc.title}</h4>
                        <p class="text-sm text-gray-600"><strong>Document:</strong> ${doc.DocumentNumber}</p>
                        <p class="text-sm text-gray-600"><strong>Category:</strong> ${doc.category}</p>
                        <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(doc.date).toLocaleDateString()}</p>
                        <p class="text-sm font-medium ${doc.status === 'Completed' ? 'text-green-600' : 'text-yellow-600'}"><strong>Status:</strong> ${doc.status}</p>
                        ${doc.status === 'Custom Remarks' && doc.customRemarks ? `<p class="text-xs text-gray-500 italic mt-1">"${doc.customRemarks}"</p>` : ''}
                    </div>
                    <div class="pt-2 border-t border-gray-100 mt-2">
                        <a href="${doc.googleDriveLink}" target="_blank" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            View Document
                        </a>
                    </div>
                `;

                if (currentUserId) {
                    const adminActions = document.createElement('div');
                    adminActions.className = "flex space-x-2 absolute top-4 right-4";
                    adminActions.innerHTML = `
                        <button class="edit-doc-btn text-blue-500 hover:text-blue-700 transition-colors duration-200" data-id="${doc.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                        </button>
                        <button class="delete-doc-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${doc.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    docCard.appendChild(adminActions);
                }
                
                documentsList.appendChild(docCard);
            });
            
            // Add listeners for edit/delete buttons after rendering
            if (currentUserId) {
                document.querySelectorAll('.edit-doc-btn').forEach(button => {
                    button.addEventListener('click', () => editDocument(button.dataset.id));
                });
                document.querySelectorAll('.delete-doc-btn').forEach(button => {
                    button.addEventListener('click', () => openDeleteModal(button.dataset.id, 'document'));
                });
            }
        }
        
        // Open delete confirmation modal
        function openDeleteModal(itemId, itemType) {
            deleteModal.classList.add('modal-open');
            confirmDeleteButton.dataset.id = itemId;
            confirmDeleteButton.dataset.type = itemType;
            deleteError.classList.add('hidden');
            document.getElementById('deleteMessage').textContent = `Are you sure you want to delete this ${itemType}? This action cannot be undone.`;
        }

        // Close delete modal and handle cancel
        cancelDeleteButton.addEventListener('click', () => {
            deleteModal.classList.remove('modal-open');
        });

        // Handle delete confirmation
        confirmDeleteButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                deleteError.textContent = "Permission denied. You must be an admin to delete.";
                deleteError.classList.remove('hidden');
                console.error("Permission denied. No user logged in.");
                return;
            }
            
            const itemId = confirmDeleteButton.dataset.id;
            const itemType = confirmDeleteButton.dataset.type;
            
            try {
                if (itemType === 'document') {
                    const docRef = doc(db, `artifacts/${appId}/public/data/documents`, itemId);
                    await deleteDoc(docRef);
                    console.log("Document deleted successfully!");
                } else if (itemType === 'category') {
                    const docRef = doc(db, `artifacts/${appId}/public/data/categories`, itemId);
                    await deleteDoc(docRef);
                    console.log("Category deleted successfully!");
                }
                deleteModal.classList.remove('modal-open');
            } catch (e) {
                console.error(`Error deleting ${itemType}: `, e);
                deleteError.textContent = `Error: ${e.message}. Deletion failed.`;
                deleteError.classList.remove('hidden');
            }
        });

        // Function to load document data into the form for editing
        async function editDocument(docId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/documents`, docId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    documentIdInput.value = docId;
                    formTitle.textContent = 'Edit Document';
                    submitButton.textContent = 'Update Document';
                    
                    document.getElementById('DocumentNumber').value = data.DocumentNumber;
                    document.getElementById('category').value = data.category;
                    document.getElementById('title').value = data.title;
                    document.getElementById('date').value = data.date;
                    document.getElementById('googleDriveLink').value = data.googleDriveLink;
                    statusSelect.value = data.status;

                    if (data.status === 'Custom Remarks') {
                        customRemarksContainer.classList.remove('hidden');
                        customRemarksInput.value = data.customRemarks;
                    } else {
                        customRemarksContainer.classList.add('hidden');
                        customRemarksInput.value = '';
                    }
                    
                    // Scroll to the admin form
                    adminSection.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (e) {
                console.error("Error fetching document for edit: ", e);
            }
        }
        
        // Function to set up the Firestore listener for documents.
        function setupFirestoreListener() {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
                unsubscribeFromFirestore = null;
            }

            const documentsCollection = collection(db, `artifacts/${appId}/public/data/documents`);
            try {
                unsubscribeFromFirestore = onSnapshot(documentsCollection, (snapshot) => {
                    const documents = [];
                    snapshot.forEach(doc => {
                        documents.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort documents by date in memory (descending)
                    documents.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Store the full list of documents in the global variable
                    allDocuments = documents;

                    // Apply current filters and render documents. Initially, this will do nothing.
                    filterAndRenderDocuments();
                });
            } catch (error) {
                console.error("Failed to set up Firestore listener for documents:", error);
            }
        }

        // Function to set up the Firestore listener for categories.
        function setupCategoriesListener() {
            if (unsubscribeFromCategories) {
                unsubscribeFromCategories();
                unsubscribeFromCategories = null;
            }

            const categoriesCollection = collection(db, `artifacts/${appId}/public/data/categories`);
            try {
                unsubscribeFromCategories = onSnapshot(categoriesCollection, (snapshot) => {
                    const defaultCategories = ['Executive Order', 'Certified as Urgent'];
                    const fetchedCategories = [];
                    
                    snapshot.forEach(doc => {
                        fetchedCategories.push({ id: doc.id, name: doc.data().name });
                    });

                    // Populate the category select dropdown
                    categorySelect.innerHTML = '';
                    defaultCategories.concat(fetchedCategories.map(c => c.name)).forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                    
                    // Populate the public category filter dropdown
                    categoryFilter.innerHTML = '<option value="">Select a Category</option>';
                    defaultCategories.concat(fetchedCategories.map(c => c.name)).forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    });


                    // Populate the list for admin to rename/delete categories
                    categoriesList.innerHTML = '';
                    
                    // First, display the hardcoded categories without action buttons
                    defaultCategories.forEach(categoryName => {
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                        categoryItem.innerHTML = `<span class="text-sm font-medium text-gray-800">${categoryName}</span>`;
                        categoriesList.appendChild(categoryItem);
                    });

                    // Then, display the custom categories with action buttons
                    fetchedCategories.forEach(category => {
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                        categoryItem.innerHTML = `
                            <span class="text-sm font-medium text-gray-800">${category.name}</span>
                            <div class="flex space-x-2">
                                <button class="rename-cat-btn text-blue-500 hover:text-blue-700" data-id="${category.id}" data-name="${category.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                </button>
                                <button class="delete-cat-btn text-red-500 hover:text-red-700" data-id="${category.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        categoriesList.appendChild(categoryItem);
                    });

                    // Attach event listeners for the new buttons
                    document.querySelectorAll('.rename-cat-btn').forEach(button => {
                        button.addEventListener('click', () => openRenameCategoryModal(button.dataset.id, button.dataset.name));
                    });
                    document.querySelectorAll('.delete-cat-btn').forEach(button => {
                        button.addEventListener('click', () => openDeleteModal(button.dataset.id, 'category'));
                    });

                });
            } catch (error) {
                console.error("Failed to set up Firestore listener for categories:", error);
            }
        }
        
        // Handle rename category modal
        function openRenameCategoryModal(id, name) {
            renameCategoryIdInput.value = id;
            renameCategoryInput.value = name;
            renameCategoryModal.classList.add('modal-open');
        }

        cancelRenameButton.addEventListener('click', () => {
            renameCategoryModal.classList.remove('modal-open');
        });

        renameCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                console.error("Permission denied. You must be an admin to rename a category.");
                return;
            }

            const id = renameCategoryIdInput.value;
            const newName = renameCategoryInput.value.trim();

            if (newName) {
                try {
                    const categoryRef = doc(db, `artifacts/${appId}/public/data/categories`, id);
                    await updateDoc(categoryRef, { name: newName });
                    console.log("Category renamed successfully!");
                } catch (e) {
                    console.error("Error renaming category:", e);
                }
            }
            renameCategoryModal.classList.remove('modal-open');
        });
        
        // --- Auth State Listener ---
        onAuthStateChanged(auth, (user) => {
            // Log the auth state for debugging
            if (user) {
                console.log(`User state changed: UID=${user.uid}`);
            } else {
                console.log("User state changed: No user logged in.");
            }
            
            currentUserId = user ? user.uid : null;
            // A non-anonymous user is an admin.
            if (user) {
                authButton.textContent = "Logout";
                userIdDisplay.textContent = `User ID: ${currentUserId}`;
                userIdDisplay.classList.remove('hidden');
                adminSection.classList.remove('hidden');
            } else {
                authButton.textContent = "Admin Login";
                userIdDisplay.classList.add('hidden');
                adminSection.classList.add('hidden');
            }
            
            // This listener should be set up for both public and admin views.
            setupFirestoreListener();
            setupCategoriesListener();
        });

        // Function to filter and render documents based on the selected category
        function filterAndRenderDocuments() {
            const selectedCategory = categoryFilter.value;
            
            // If no category is selected, clear the list and display a message.
            if (selectedCategory === "") {
                documentsList.innerHTML = `<p class="text-center text-gray-500 col-span-full">Please select a category to view documents.</p>`;
                return;
            }
            
            // Filter the documents by the selected category
            let filteredDocuments = allDocuments.filter(doc => doc.category === selectedCategory);

            renderDocuments(filteredDocuments);
        }
        
        // Event listener for filtering
        categoryFilter.addEventListener('change', filterAndRenderDocuments);

    </script>
</body>
</html>
